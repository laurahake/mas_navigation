<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mas_navigation.custom_environment &#8212; Multi-Agent Path Planning and Navigation with A* and Q-Learning 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=f2a433a1"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for mas_navigation.custom_environment</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pygame</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">from</span> <span class="nn">.node_class</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span> <span class="nn">gymnasium.utils</span> <span class="kn">import</span> <span class="n">EzPickle</span>
<span class="kn">from</span> <span class="nn">gymnasium.core</span> <span class="kn">import</span> <span class="n">ObsType</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">simple_pid</span> <span class="kn">import</span> <span class="n">PID</span>

<span class="kn">from</span> <span class="nn">pettingzoo.mpe._mpe_utils.core</span> <span class="kn">import</span> <span class="n">World</span> <span class="k">as</span> <span class="n">BaseWorld</span>
<span class="kn">from</span> <span class="nn">pettingzoo.mpe._mpe_utils.core</span> <span class="kn">import</span> <span class="n">Landmark</span> <span class="k">as</span> <span class="n">BaseLandmark</span>
<span class="kn">from</span> <span class="nn">pettingzoo.mpe._mpe_utils.core</span> <span class="kn">import</span> <span class="n">Agent</span> <span class="k">as</span> <span class="n">BaseAgent</span>
<span class="kn">from</span> <span class="nn">pettingzoo.mpe._mpe_utils.scenario</span> <span class="kn">import</span> <span class="n">BaseScenario</span>
<span class="kn">from</span> <span class="nn">pettingzoo.mpe._mpe_utils.simple_env</span> <span class="kn">import</span> <span class="n">SimpleEnv</span><span class="p">,</span> <span class="n">make_env</span>
<span class="kn">from</span> <span class="nn">pettingzoo.utils.conversions</span> <span class="kn">import</span> <span class="n">parallel_wrapper_fn</span>


<div class="viewcode-block" id="raw_print_state">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.raw_print_state">[docs]</a>
<span class="k">def</span> <span class="nf">raw_print_state</span><span class="p">(</span><span class="n">grid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print a 2D integer grid to stdout.</span>

<span class="sd">    Prints rows from top to bottom for quick inspection of the state before state aggregation.</span>

<span class="sd">    Args:</span>
<span class="sd">        grid (list[list[int]]): 2D grid of cells. Each cell is an integer representing the state of that cell.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The state is:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cell</span><span class="si">:</span><span class="s2">2</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">row</span><span class="p">))</span></div>

        
<div class="viewcode-block" id="print_state">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.print_state">[docs]</a>
<span class="k">def</span> <span class="nf">print_state</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print the compact Q-state representation.</span>

<span class="sd">    The layout shows a 3x3 center region and four aggregated directional regions</span>
<span class="sd">    in the order top, left, right, bottom.</span>
<span class="sd">    The center cell represents the A* action direction.</span>

<span class="sd">    Args:</span>
<span class="sd">        state (Sequence[int]): Encoded state. First 9 entries are the center 3Ã—3 region.</span>
<span class="sd">            Entries 9..12 encode the four aggregated regions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Q-State Representation ===&quot;</span><span class="p">)</span>
    
    <span class="c1"># Extract segments</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">state</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span>  <span class="c1"># 3x3 fine grid</span>
    <span class="n">top</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
    <span class="n">left</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
    <span class="n">bottom</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>
    
    <span class="c1"># Print layout:</span>
    <span class="c1">#     [ T ]</span>
    <span class="c1"># [L] [Center 3x3] [R]</span>
    <span class="c1">#     [ B ]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Top: </span><span class="si">{</span><span class="n">top</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Center Grid:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">center</span><span class="p">[</span><span class="n">r</span><span class="o">*</span><span class="mi">3</span><span class="p">:(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;        &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">2</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row</span><span class="p">))</span>
        
    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Left: </span><span class="si">{</span><span class="n">left</span><span class="si">}</span><span class="s2">       Right: </span><span class="si">{</span><span class="n">right</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Bottom: </span><span class="si">{</span><span class="n">bottom</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;==============================</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

        
        
<div class="viewcode-block" id="Agent">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.Agent">[docs]</a>
<span class="k">class</span> <span class="nc">Agent</span><span class="p">(</span><span class="n">BaseAgent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mobile agent with A* guidance, Q-learning state, and simple PID tracking.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        a_star_old (list[tuple[float, float]]): Already reached A* waypoints.</span>
<span class="sd">        a_star_new (list[tuple[float, float]]): Remaining A* waypoints.</span>
<span class="sd">        goal_point (list[float, float]): Goal position in world coordinates.</span>
<span class="sd">        q_state (tuple[int, ...]): Current Q-learning state encoding.</span>
<span class="sd">        controller_x (PID): PID controller for x-axis velocity command.</span>
<span class="sd">        controller_y (PID): PID controller for y-axis velocity command.</span>
<span class="sd">        terminated (bool): Set when the agent encountered a terminal event.</span>
<span class="sd">        a_star_action (int | None): Last A*-aligned discrete action {0,1,2,3}.</span>
<span class="sd">        action_history (list[int]): Last few executed discrete actions.</span>
<span class="sd">        reward (float): Last assigned scalar reward.</span>

<span class="sd">    Args:</span>
<span class="sd">        Kp (float): Proportional gain for both PID controllers.</span>
<span class="sd">        Ki (float): Integral gain for both PID controllers.</span>
<span class="sd">        Kd (float): Derivative gain for both PID controllers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Kp</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">Ki</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Kd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_star_old</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_star_new</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goal_point</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_state</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller_x</span> <span class="o">=</span> <span class="n">PID</span><span class="p">(</span><span class="n">Kp</span><span class="p">,</span> <span class="n">Ki</span><span class="p">,</span> <span class="n">Kd</span><span class="p">,</span> <span class="n">setpoint</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller_y</span> <span class="o">=</span> <span class="n">PID</span><span class="p">(</span><span class="n">Kp</span><span class="p">,</span> <span class="n">Ki</span><span class="p">,</span> <span class="n">Kd</span><span class="p">,</span> <span class="n">setpoint</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terminated</span> <span class="o">=</span>  <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_star_action</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reward</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectory</span> <span class="o">=</span> <span class="p">[]</span></div>



<div class="viewcode-block" id="Landmark">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.Landmark">[docs]</a>
<span class="k">class</span> <span class="nc">Landmark</span><span class="p">(</span><span class="n">BaseLandmark</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Goal landmark.</span>

<span class="sd">    The landmark is nonâ€‘movable and used to check goal proximity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

<div class="viewcode-block" id="Landmark.is_collision">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.Landmark.is_collision">[docs]</a>
    <span class="k">def</span> <span class="nf">is_collision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if the agent overlaps the landmark.</span>

<span class="sd">        Uses Euclidean distance and the agent radius.</span>

<span class="sd">        Args:</span>
<span class="sd">            agent (Agent): Agent instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the agent is within its radius of the landmark center.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">euclidian_dis</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">euclidian_dis</span> <span class="o">&lt;=</span> <span class="n">agent</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>
</div>


<div class="viewcode-block" id="RandomLandmark">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.RandomLandmark">[docs]</a>
<span class="k">class</span> <span class="nc">RandomLandmark</span><span class="p">(</span><span class="n">BaseLandmark</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rectangular landmark that can be used as a random obstacle in training. Currently not used in the environment.</span>

<span class="sd">    The rectangle is represented by center position and width Ã— height in meters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize rectangle size.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
    
<div class="viewcode-block" id="RandomLandmark.is_collision">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.RandomLandmark.is_collision">[docs]</a>
    <span class="k">def</span> <span class="nf">is_collision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if the agent is inside the rectangle.</span>

<span class="sd">        Args:</span>
<span class="sd">            agent (Agent): Agent instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the agent center lies within the rectangle bounds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">x_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">y_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
    
        <span class="n">agent_x</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">agent_y</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
        <span class="k">return</span> <span class="n">x_min</span> <span class="o">&lt;=</span> <span class="n">agent_x</span> <span class="o">&lt;=</span> <span class="n">x_max</span> <span class="ow">and</span> <span class="n">y_min</span> <span class="o">&lt;=</span> <span class="n">agent_y</span> <span class="o">&lt;=</span> <span class="n">y_max</span></div>

    
<div class="viewcode-block" id="RandomLandmark.get_distance">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.RandomLandmark.get_distance">[docs]</a>
    <span class="k">def</span> <span class="nf">get_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_x</span><span class="p">,</span> <span class="n">agent_y</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return absolute x and y offsets from the rectangle center.</span>

<span class="sd">        Args:</span>
<span class="sd">            agent_x (float): Agent x coordinate.</span>
<span class="sd">            agent_y (float): Agent y coordinate.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[float, float]: Absolute delta in x and y.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dis_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">agent_x</span>
        <span class="n">dis_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">agent_y</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dis_x</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dis_y</span><span class="p">)</span></div>
</div>

    
<div class="viewcode-block" id="RectLandmark">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.RectLandmark">[docs]</a>
<span class="k">class</span> <span class="nc">RectLandmark</span><span class="p">(</span><span class="n">BaseLandmark</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rectangular landmark used as a static obstacle in planning and runtime.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">])</span>
    
<div class="viewcode-block" id="RectLandmark.is_collision">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.RectLandmark.is_collision">[docs]</a>
    <span class="k">def</span> <span class="nf">is_collision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if the agent overlaps the rectangle.</span>

<span class="sd">        Collision uses rectangle bounds expanded by circles around the rectanlgle corners.</span>

<span class="sd">        Args:</span>
<span class="sd">            agent (Agent): Agent instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the agent center intersects the expanded rectangle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">size</span>
        <span class="n">agent_x</span><span class="p">,</span> <span class="n">agent_y</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span>
        <span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span>

        <span class="n">half_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">buffer</span>
        <span class="n">half_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">buffer</span>

        <span class="c1"># Bounding box check</span>
        <span class="k">if</span> <span class="n">center_x</span> <span class="o">-</span> <span class="n">half_width</span> <span class="o">&lt;=</span> <span class="n">agent_x</span> <span class="o">&lt;=</span> <span class="n">center_x</span> <span class="o">+</span> <span class="n">half_width</span> <span class="ow">and</span> \
        <span class="n">center_y</span> <span class="o">-</span> <span class="n">half_height</span> <span class="o">&lt;=</span> <span class="n">agent_y</span> <span class="o">&lt;=</span> <span class="n">center_y</span> <span class="o">+</span> <span class="n">half_height</span><span class="p">:</span>
            
            <span class="c1"># Corner circles for leniency</span>
            <span class="n">corner_radius</span> <span class="o">=</span> <span class="mf">0.01</span>
            <span class="n">corners</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">center_x</span> <span class="o">-</span> <span class="n">half_width</span><span class="p">,</span> <span class="n">center_y</span> <span class="o">-</span> <span class="n">half_height</span><span class="p">),</span>
                <span class="p">(</span><span class="n">center_x</span> <span class="o">+</span> <span class="n">half_width</span><span class="p">,</span> <span class="n">center_y</span> <span class="o">-</span> <span class="n">half_height</span><span class="p">),</span>  
                <span class="p">(</span><span class="n">center_x</span> <span class="o">-</span> <span class="n">half_width</span><span class="p">,</span> <span class="n">center_y</span> <span class="o">+</span> <span class="n">half_height</span><span class="p">),</span>  
                <span class="p">(</span><span class="n">center_x</span> <span class="o">+</span> <span class="n">half_width</span><span class="p">,</span> <span class="n">center_y</span> <span class="o">+</span> <span class="n">half_height</span><span class="p">),</span>  
            <span class="p">]</span>
            
            <span class="k">for</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="ow">in</span> <span class="n">corners</span><span class="p">:</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">([</span><span class="n">agent_x</span> <span class="o">-</span> <span class="n">cx</span><span class="p">,</span> <span class="n">agent_y</span> <span class="o">-</span> <span class="n">cy</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">corner_radius</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>
</div>

    
<div class="viewcode-block" id="World">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.World">[docs]</a>
<span class="k">class</span> <span class="nc">World</span><span class="p">(</span><span class="n">BaseWorld</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;World with custom continuous dynamics and collision handling for mixed shapes.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
    
<div class="viewcode-block" id="World.integrate_state">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.World.integrate_state">[docs]</a>
    <span class="k">def</span> <span class="nf">integrate_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_force</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Integrate positions using applied forces and reset velocities.</span>

<span class="sd">        Args:</span>
<span class="sd">            p_force (list[np.ndarray | None]): Per-entity force vectors in world coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">entity</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">entity</span><span class="o">.</span><span class="n">movable</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="k">if</span> <span class="n">p_force</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">entity</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span> <span class="o">+=</span> <span class="n">p_force</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
                
            <span class="n">entity</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_vel</span><span class="p">)</span></div>

    
    
<div class="viewcode-block" id="World.apply_action_force">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.World.apply_action_force">[docs]</a>
    <span class="k">def</span> <span class="nf">apply_action_force</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_force</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Map agent actions to planar forces.</span>

<span class="sd">        The first two entries of the action vector are interpreted as desired planar velocities.</span>
<span class="sd">        A global scale is applied when converting to forces.</span>

<span class="sd">        Args:</span>
<span class="sd">            p_force (list[np.ndarray | None]): Force accumulator.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[np.ndarray | None]: Updated force accumulator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># set applied forces</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">agent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">movable</span><span class="p">:</span>
                <span class="n">action</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">u</span>  <span class="c1"># [0, -vx, 0, -vy, 0]</span>
                <span class="n">vx</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">vy</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="mf">2.0</span>
                <span class="n">p_force</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">vx</span><span class="p">,</span> <span class="n">vy</span><span class="p">])</span><span class="o">*</span> <span class="n">scale</span>
        <span class="k">return</span> <span class="n">p_force</span></div>

    
<div class="viewcode-block" id="World.apply_environment_force">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.World.apply_environment_force">[docs]</a>
    <span class="k">def</span> <span class="nf">apply_environment_force</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_force</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply environment forces such as contacts. Currently a no-op.</span>

<span class="sd">        Stub that returns the input unchanged.</span>

<span class="sd">        Args:</span>
<span class="sd">            p_force (list[np.ndarray | None]): Force accumulator.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[np.ndarray | None]: Unchanged force accumulator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">p_force</span></div>

    
    <span class="c1"># get collision forces for any contact between two entities</span>
<div class="viewcode-block" id="World.get_collision_force">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.World.get_collision_force">[docs]</a>
    <span class="k">def</span> <span class="nf">get_collision_force</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_a</span><span class="p">,</span> <span class="n">entity_b</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute contact forces and termination flags between two entities.</span>

<span class="sd">        Handles three cases: rectangleâ€“rectangle, rectangleâ€“disk, and diskâ€“disk.</span>
<span class="sd">        Uses a soft penetration model with contact margin and sets termination flags</span>
<span class="sd">        on agents upon significant penetration.</span>

<span class="sd">        Args:</span>
<span class="sd">            entity_a: First entity.</span>
<span class="sd">            entity_b: Second entity.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[np.ndarray | None, np.ndarray | None]: Force on A and force on B.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">entity_a</span><span class="o">.</span><span class="n">collide</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">entity_b</span><span class="o">.</span><span class="n">collide</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>  <span class="c1"># not a collider</span>
        <span class="k">if</span> <span class="n">entity_a</span> <span class="ow">is</span> <span class="n">entity_b</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>  <span class="c1"># don&#39;t collide against itsel</span>
        
        <span class="c1"># Rectangle to Rectangle collision</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity_a</span><span class="p">,</span> <span class="p">(</span><span class="n">RectLandmark</span><span class="p">,</span> <span class="n">RandomLandmark</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity_b</span><span class="p">,</span> <span class="p">(</span><span class="n">RectLandmark</span><span class="p">,</span> <span class="n">RandomLandmark</span><span class="p">)):</span>
            <span class="n">delta_pos</span> <span class="o">=</span> <span class="n">entity_a</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span> <span class="o">-</span> <span class="n">entity_b</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span>
            <span class="n">dist_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">delta_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  
            <span class="n">dist_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">delta_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  

            <span class="n">half_width_a</span> <span class="o">=</span> <span class="n">entity_a</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">half_height_a</span> <span class="o">=</span> <span class="n">entity_a</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">half_width_b</span> <span class="o">=</span> <span class="n">entity_b</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">half_height_b</span> <span class="o">=</span> <span class="n">entity_b</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
            
            <span class="n">dist_min_x</span> <span class="o">=</span> <span class="n">half_width_a</span> <span class="o">+</span> <span class="n">half_width_b</span>
            <span class="n">dist_min_y</span> <span class="o">=</span> <span class="n">half_height_a</span> <span class="o">+</span> <span class="n">half_height_b</span>
            
            <span class="c1"># softmax penetration</span>
            <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contact_margin</span>
            
            <span class="n">penetration_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logaddexp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">dist_x</span> <span class="o">-</span> <span class="n">dist_min_x</span><span class="p">)</span> <span class="o">/</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">k</span>
            <span class="n">penetration_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logaddexp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">dist_y</span> <span class="o">-</span> <span class="n">dist_min_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">k</span>
            
            <span class="k">if</span> <span class="n">penetration_x</span> <span class="o">&gt;</span> <span class="mf">0.01</span> <span class="ow">and</span> <span class="n">penetration_y</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">penetration_x</span> <span class="o">&gt;</span> <span class="n">penetration_y</span><span class="p">:</span>
                    <span class="n">force_magnitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contact_force</span> <span class="o">*</span> <span class="n">penetration_x</span>
                    <span class="n">force_direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">delta_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">force_magnitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contact_force</span> <span class="o">*</span> <span class="n">penetration_y</span>
                    <span class="n">force_direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">delta_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
                    
                <span class="n">force</span> <span class="o">=</span> <span class="n">force_magnitude</span> <span class="o">*</span> <span class="n">force_direction</span>
                <span class="n">force_a</span> <span class="o">=</span> <span class="n">force</span> <span class="k">if</span> <span class="n">entity_a</span><span class="o">.</span><span class="n">movable</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">force_b</span> <span class="o">=</span> <span class="o">-</span><span class="n">force</span> <span class="k">if</span> <span class="n">entity_b</span><span class="o">.</span><span class="n">movable</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">force_a</span><span class="p">,</span> <span class="n">force_b</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        
        <span class="c1"># Rectangle to Non-Rectangle collision</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity_a</span><span class="p">,</span> <span class="p">(</span><span class="n">RectLandmark</span><span class="p">,</span> <span class="n">RandomLandmark</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity_b</span><span class="p">,</span> <span class="p">(</span><span class="n">RectLandmark</span><span class="p">,</span> <span class="n">RandomLandmark</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity_a</span><span class="p">,</span> <span class="p">(</span><span class="n">RectLandmark</span><span class="p">,</span> <span class="n">RandomLandmark</span><span class="p">)):</span>
                <span class="n">rect_entity</span> <span class="o">=</span> <span class="n">entity_a</span>
                <span class="n">non_rect_entity</span> <span class="o">=</span> <span class="n">entity_b</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">rect_entity</span> <span class="o">=</span> <span class="n">entity_b</span>
                <span class="n">non_rect_entity</span> <span class="o">=</span> <span class="n">entity_a</span>
                
            <span class="n">delta_pos</span> <span class="o">=</span> <span class="n">entity_a</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span> <span class="o">-</span> <span class="n">entity_b</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span>
            <span class="n">dist_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">delta_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  
            <span class="n">dist_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">delta_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">half_width</span> <span class="o">=</span> <span class="n">rect_entity</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">half_height</span> <span class="o">=</span> <span class="n">rect_entity</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
            
            <span class="n">dist_min_x</span> <span class="o">=</span> <span class="n">half_width</span> <span class="o">+</span> <span class="n">non_rect_entity</span><span class="o">.</span><span class="n">size</span>
            <span class="n">dist_min_y</span> <span class="o">=</span> <span class="n">half_height</span> <span class="o">+</span> <span class="n">non_rect_entity</span><span class="o">.</span><span class="n">size</span>
            
            <span class="c1"># softmax penetration</span>
            <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contact_margin</span>
            <span class="n">penetration_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logaddexp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">dist_x</span> <span class="o">-</span> <span class="n">dist_min_x</span><span class="p">)</span> <span class="o">/</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">k</span>
            <span class="n">penetration_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logaddexp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">dist_y</span> <span class="o">-</span> <span class="n">dist_min_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">k</span>
            
            <span class="k">if</span> <span class="n">penetration_x</span> <span class="o">&gt;</span> <span class="mf">0.01</span> <span class="ow">and</span> <span class="n">penetration_y</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>
                <span class="n">non_rect_entity</span><span class="o">.</span><span class="n">terminated</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">penetration_x</span> <span class="o">&gt;</span> <span class="n">penetration_y</span><span class="p">:</span>
                    <span class="n">penetration</span> <span class="o">=</span> <span class="n">penetration_x</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">delta_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">penetration</span> <span class="o">=</span> <span class="n">penetration_y</span>
                    <span class="n">direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">delta_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>

                <span class="n">force</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contact_force</span> <span class="o">*</span> <span class="n">direction</span> <span class="o">*</span> <span class="n">penetration</span>
                <span class="n">force_rect</span> <span class="o">=</span> <span class="o">-</span><span class="n">force</span> <span class="k">if</span> <span class="n">rect_entity</span><span class="o">.</span><span class="n">movable</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">force_non_rect</span> <span class="o">=</span> <span class="n">force</span> <span class="k">if</span> <span class="n">non_rect_entity</span><span class="o">.</span><span class="n">movable</span> <span class="k">else</span> <span class="kc">None</span>
                
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity_a</span><span class="p">,</span> <span class="p">(</span><span class="n">RectLandmark</span><span class="p">,</span> <span class="n">RandomLandmark</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="p">[</span><span class="n">force_rect</span><span class="p">,</span> <span class="n">force_non_rect</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="k">return</span> <span class="p">[</span><span class="n">force_non_rect</span><span class="p">,</span> <span class="n">force_rect</span><span class="p">]</span>
                
            <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        
        <span class="c1"># Non-Rectangle to Non-Rectangle collision</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity_a</span><span class="p">,</span> <span class="p">(</span><span class="n">RectLandmark</span><span class="p">,</span> <span class="n">RandomLandmark</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity_b</span><span class="p">,</span> <span class="p">(</span><span class="n">RectLandmark</span><span class="p">,</span> <span class="n">RandomLandmark</span><span class="p">)):</span>        
            <span class="c1"># compute actual distance between entities</span>
            <span class="n">delta_pos</span> <span class="o">=</span> <span class="n">entity_a</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span> <span class="o">-</span> <span class="n">entity_b</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">delta_pos</span><span class="p">)))</span>
            <span class="c1"># minimum allowable distance</span>
            <span class="n">dist_min</span> <span class="o">=</span> <span class="n">entity_a</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">entity_b</span><span class="o">.</span><span class="n">size</span>
            <span class="c1"># softmax penetration</span>
            <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contact_margin</span>
            <span class="n">penetration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logaddexp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">dist</span> <span class="o">-</span> <span class="n">dist_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">k</span>
            <span class="k">if</span> <span class="n">penetration</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>
                <span class="n">entity_a</span><span class="o">.</span><span class="n">terminated</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">entity_b</span><span class="o">.</span><span class="n">terminated</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">force</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contact_force</span> <span class="o">*</span> <span class="n">delta_pos</span> <span class="o">/</span> <span class="n">dist</span> <span class="o">*</span> <span class="n">penetration</span>
            <span class="n">force_a</span> <span class="o">=</span> <span class="o">+</span><span class="n">force</span> <span class="k">if</span> <span class="n">entity_a</span><span class="o">.</span><span class="n">movable</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">force_b</span> <span class="o">=</span> <span class="o">-</span><span class="n">force</span> <span class="k">if</span> <span class="n">entity_b</span><span class="o">.</span><span class="n">movable</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">force_a</span><span class="p">,</span> <span class="n">force_b</span><span class="p">]</span></div>
</div>



<div class="viewcode-block" id="raw_env">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.raw_env">[docs]</a>
<span class="k">class</span> <span class="nc">raw_env</span><span class="p">(</span><span class="n">SimpleEnv</span><span class="p">,</span> <span class="n">EzPickle</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;PettingZoo MPE environment with A*, local state encoding, and tabular Q-Learning.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_good</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">num_obstacles</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">max_cycles</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">continuous_actions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">render_mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create scenario, world, and base SimpleEnv.</span>

<span class="sd">        Args:</span>
<span class="sd">            num_good (int): Number of agents.</span>
<span class="sd">            num_obstacles (int): Number of rectangular landmarks.</span>
<span class="sd">            max_cycles (int): Step limit per episode.</span>
<span class="sd">            continuous_actions (bool): Use continuous action vectors.</span>
<span class="sd">            render_mode (str | None): None or &quot;human&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">EzPickle</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">num_good</span><span class="o">=</span><span class="n">num_good</span><span class="p">,</span>
            <span class="n">num_obstacles</span><span class="o">=</span><span class="n">num_obstacles</span><span class="p">,</span>
            <span class="n">max_cycles</span><span class="o">=</span><span class="n">max_cycles</span><span class="p">,</span>
            <span class="n">continuous_actions</span><span class="o">=</span><span class="n">continuous_actions</span><span class="p">,</span>
            <span class="n">render_mode</span><span class="o">=</span><span class="n">render_mode</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">scenario</span> <span class="o">=</span> <span class="n">Scenario</span><span class="p">()</span>
        <span class="n">world</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">make_world</span><span class="p">(</span><span class="n">num_good</span><span class="p">,</span> <span class="n">num_obstacles</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_runtime</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">epsilon_runtime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_planning</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">epsilon_planning</span>
        
        <span class="n">SimpleEnv</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">,</span>
            <span class="n">world</span><span class="o">=</span><span class="n">world</span><span class="p">,</span>
            <span class="n">render_mode</span><span class="o">=</span><span class="n">render_mode</span><span class="p">,</span>
            <span class="n">max_cycles</span><span class="o">=</span><span class="n">max_cycles</span><span class="p">,</span>
            <span class="n">continuous_actions</span><span class="o">=</span><span class="n">continuous_actions</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;custom_environment&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_agents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="n">size</span><span class="p">)</span>
        
<div class="viewcode-block" id="raw_env.draw">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.raw_env.draw">[docs]</a>
    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Render entities, goals, and local grid overlay with pygame.</span>

<span class="sd">        Assumes an initialized pygame screen and viewport. Draws agents as disks,</span>
<span class="sd">        goals as rings, obstacles as rectangles, and the local grid around each agent.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AssertionError: If screen coordinates compute out of bounds.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># clear screen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="o">.</span><span class="n">fill</span><span class="p">((</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>

        <span class="c1"># update bounds to center around agent</span>
        <span class="n">all_poses</span> <span class="o">=</span> <span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span> <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">entities</span><span class="p">]</span>
        <span class="n">cam_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed_cam_range</span>

        <span class="c1"># update geometry and text positions</span>
        <span class="n">text_line</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">entity</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">entities</span><span class="p">):</span>
            <span class="c1"># geometry</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span>
            <span class="n">y</span> <span class="o">*=</span> <span class="p">(</span>
                <span class="o">-</span><span class="mi">1</span>
            <span class="p">)</span>  <span class="c1"># this makes the display mimic the old pyglet setup (ie. flips image)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">cam_range</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">0.9</span>
            <span class="p">)</span>  <span class="c1"># the .9 is just to keep entities from appearing &quot;too&quot; out-of-bounds</span>
            <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">/</span> <span class="n">cam_range</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">0.9</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">y</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">//</span> <span class="mi">2</span>
            
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">RectLandmark</span><span class="p">):</span>
                <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">size</span>
                <span class="n">scale_factor</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">cam_range</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.9</span>  <span class="c1"># Match the scaling of positions</span>
                <span class="n">rect_width</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">scale_factor</span>
                <span class="n">rect_height</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="n">scale_factor</span>
                <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">,</span>
                    <span class="n">entity</span><span class="o">.</span><span class="n">color</span> <span class="o">*</span> <span class="mi">200</span><span class="p">,</span>
                    <span class="n">pygame</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span>
                        <span class="n">x</span> <span class="o">-</span> <span class="n">rect_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="n">y</span> <span class="o">-</span> <span class="n">rect_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="n">rect_width</span><span class="p">,</span>
                        <span class="n">rect_height</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">,</span>
                    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Randfarbe (schwarz)</span>
                    <span class="n">pygame</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span>
                        <span class="n">x</span> <span class="o">-</span> <span class="n">rect_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="n">y</span> <span class="o">-</span> <span class="n">rect_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="n">rect_width</span><span class="p">,</span>
                        <span class="n">rect_height</span>
                    <span class="p">),</span> 
                    <span class="mi">1</span>  <span class="c1"># Randdicke</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">RandomLandmark</span><span class="p">):</span>
                <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">size</span>
                <span class="n">scale_factor</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">cam_range</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.9</span>  <span class="c1"># Match the scaling of positions</span>
                <span class="n">rect_width</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">scale_factor</span>
                <span class="n">rect_height</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="n">scale_factor</span>
                <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">,</span>
                    <span class="n">entity</span><span class="o">.</span><span class="n">color</span> <span class="o">*</span> <span class="mi">200</span><span class="p">,</span>
                    <span class="n">pygame</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span>
                        <span class="n">x</span> <span class="o">-</span> <span class="n">rect_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="n">y</span> <span class="o">-</span> <span class="n">rect_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="n">rect_width</span><span class="p">,</span>
                        <span class="n">rect_height</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">,</span>
                    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>  <span class="c1"># Randfarbe (schwarz)</span>
                    <span class="n">pygame</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span>
                        <span class="n">x</span> <span class="o">-</span> <span class="n">rect_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="n">y</span> <span class="o">-</span> <span class="n">rect_height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="n">rect_width</span><span class="p">,</span>
                        <span class="n">rect_height</span>
                    <span class="p">),</span> 
                    <span class="mi">1</span>  <span class="c1"># Randdicke</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">Agent</span><span class="p">):</span>
                <span class="n">scale_factor</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">cam_range</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.9</span>
                <span class="n">agent_radius</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">scale_factor</span> 
                
                <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">color</span> <span class="o">*</span> <span class="mi">200</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">agent_radius</span>
                <span class="p">)</span>
                <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">agent_radius</span><span class="p">,</span> <span class="mi">1</span>
                <span class="p">)</span>
                <span class="c1"># Draw start position marker (small filled circle)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s2">&quot;start_pos&quot;</span><span class="p">):</span>
                    <span class="n">start_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">start_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">cam_range</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">0.9</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">//</span> <span class="mi">2</span>
                    <span class="n">start_y</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">entity</span><span class="o">.</span><span class="n">start_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">cam_range</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">0.9</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">//</span> <span class="mi">2</span>

                    <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">,</span>
                        <span class="n">entity</span><span class="o">.</span><span class="n">color</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span>  
                        <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">start_x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_y</span><span class="p">)),</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">agent_radius</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>  
                    <span class="p">)</span>
                
                <span class="c1"># draw agent trajectory</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s2">&quot;trajectory&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">trajectory</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">cam_range</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.9</span>
                    <span class="n">screen_points</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">trajectory</span><span class="p">:</span>
                        <span class="n">tx</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">cam_range</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">0.9</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">//</span> <span class="mi">2</span>
                        <span class="n">ty</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">cam_range</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">0.9</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">//</span> <span class="mi">2</span>  <span class="c1"># flip y</span>
                        <span class="n">screen_points</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">tx</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">ty</span><span class="p">)))</span>

                    <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">lines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">color</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">screen_points</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="c1"># draw goal point</span>
                <span class="n">goal_x</span><span class="p">,</span> <span class="n">goal_y</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">goal_point</span>
                <span class="n">goal_y</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># Flipping the y-axis</span>

                <span class="n">goal_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">goal_x</span> <span class="o">/</span> <span class="n">cam_range</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">0.9</span>
                <span class="n">goal_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">goal_y</span> <span class="o">/</span> <span class="n">cam_range</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">0.9</span>
                <span class="n">goal_x</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">//</span> <span class="mi">2</span>
                <span class="n">goal_y</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">//</span> <span class="mi">2</span>
                <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">color</span> <span class="o">*</span> <span class="mi">200</span><span class="p">,</span> <span class="p">(</span><span class="n">goal_x</span><span class="p">,</span> <span class="n">goal_y</span><span class="p">),</span> <span class="n">agent_radius</span><span class="p">,</span> <span class="mi">6</span>
                <span class="p">)</span>
                
                <span class="n">cell_size</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">scale_factor</span>
                <span class="c1"># Draw center 3x3 grid</span>
                <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                        <span class="n">cell_x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">cell_size</span>
                        <span class="n">cell_y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">cell_size</span>
                        <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">,</span>
                            <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
                            <span class="n">pygame</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span>
                                <span class="n">cell_x</span> <span class="o">-</span> <span class="n">cell_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                                <span class="n">cell_y</span> <span class="o">-</span> <span class="n">cell_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                                <span class="n">cell_size</span><span class="p">,</span>
                                <span class="n">cell_size</span>
                            <span class="p">),</span>
                            <span class="mi">1</span>
                        <span class="p">)</span>

                <span class="c1"># Draw 3x4 regions: top, bottom, left, right</span>
                <span class="c1"># Top region (3 wide, 4 high)</span>
                <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
                        <span class="n">cx</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">cell_size</span>
                        <span class="n">cy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">dy</span><span class="p">)</span> <span class="o">*</span> <span class="n">cell_size</span>
                        <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">,</span>
                            <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
                            <span class="n">pygame</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span>
                                <span class="n">cx</span> <span class="o">-</span> <span class="n">cell_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                                <span class="n">cy</span> <span class="o">-</span> <span class="n">cell_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                                <span class="n">cell_size</span><span class="p">,</span>
                                <span class="n">cell_size</span>
                            <span class="p">),</span>
                            <span class="mi">1</span>
                        <span class="p">)</span>

                <span class="c1"># Bottom region</span>
                <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
                        <span class="n">cx</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">cell_size</span>
                        <span class="n">cy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">dy</span><span class="p">)</span> <span class="o">*</span> <span class="n">cell_size</span>
                        <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">,</span>
                            <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
                            <span class="n">pygame</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span>
                                <span class="n">cx</span> <span class="o">-</span> <span class="n">cell_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                                <span class="n">cy</span> <span class="o">-</span> <span class="n">cell_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                                <span class="n">cell_size</span><span class="p">,</span>
                                <span class="n">cell_size</span>
                            <span class="p">),</span>
                            <span class="mi">1</span>
                        <span class="p">)</span>

                <span class="c1"># Left region (4 wide, 3 high)</span>
                <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                        <span class="n">cx</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">dx</span><span class="p">)</span> <span class="o">*</span> <span class="n">cell_size</span>
                        <span class="n">cy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">cell_size</span>
                        <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">,</span>
                            <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
                            <span class="n">pygame</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span>
                                <span class="n">cx</span> <span class="o">-</span> <span class="n">cell_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                                <span class="n">cy</span> <span class="o">-</span> <span class="n">cell_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                                <span class="n">cell_size</span><span class="p">,</span>
                                <span class="n">cell_size</span>
                            <span class="p">),</span>
                            <span class="mi">1</span>
                        <span class="p">)</span>

                <span class="c1"># Right region</span>
                <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                        <span class="n">cx</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">dx</span><span class="p">)</span> <span class="o">*</span> <span class="n">cell_size</span>
                        <span class="n">cy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">cell_size</span>
                        <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">,</span>
                            <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
                            <span class="n">pygame</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span>
                                <span class="n">cx</span> <span class="o">-</span> <span class="n">cell_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                                <span class="n">cy</span> <span class="o">-</span> <span class="n">cell_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                                <span class="n">cell_size</span><span class="p">,</span>
                                <span class="n">cell_size</span>
                            <span class="p">),</span>
                            <span class="mi">1</span>
                        <span class="p">)</span>
            
            <span class="k">assert</span> <span class="p">(</span>
                <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Coordinates </span><span class="si">{</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2"> are out of bounds.&quot;</span></div>

    
                
<div class="viewcode-block" id="raw_env.is_obstacle">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.raw_env.is_obstacle">[docs]</a>
    <span class="k">def</span> <span class="nf">is_obstacle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">q_learning</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">override_epsilon</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return True if (x, y) lies inside an obstacle region.</span>

<span class="sd">        Semantics</span>

<span class="sd">        Planning / state encoding (``q_learning=True``)</span>
<span class="sd">            Rectangular and random rectangular landmarks are treated as obstacles</span>
<span class="sd">            using the planning margin (``epsilon_planning``). The outer boundary</span>
<span class="sd">            is not checked here because A* paths do not intersect walls.</span>

<span class="sd">        Runtime (``q_learning=False``)</span>
<span class="sd">            Only rectangular landmarks are treated as obstacles using the runtime</span>
<span class="sd">            margin (``epsilon_runtime``). Out-of-bounds is handled by</span>
<span class="sd">            :meth:`Scenario.is_out_of_bounds` and not here.</span>

<span class="sd">        The active epsilon can be overridden via ``override_epsilon``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : float</span>
<span class="sd">            World x coordinate.</span>
<span class="sd">        y : float</span>
<span class="sd">            World y coordinate.</span>
<span class="sd">        q_learning : bool, optional</span>
<span class="sd">            If True, use planning semantics and margin; if False, use runtime semantics and margin.</span>
<span class="sd">        override_epsilon : float or None, optional</span>
<span class="sd">            Margin that replaces the default.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if the point is inside an obstacle region under the selected semantics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">epsilon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_planning</span> <span class="k">if</span> <span class="n">q_learning</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_runtime</span>
        <span class="k">if</span> <span class="n">override_epsilon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">epsilon</span> <span class="o">=</span> <span class="n">override_epsilon</span>
        <span class="c1"># check for collision with wall</span>
        <span class="n">border_limit</span> <span class="o">=</span> <span class="mf">0.98</span> 
        <span class="k">if</span> <span class="n">q_learning</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">border_limit</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">border_limit</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        
        <span class="k">for</span> <span class="n">landmark</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">landmarks</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">landmark</span><span class="p">,</span> <span class="p">(</span><span class="n">RectLandmark</span><span class="p">,</span> <span class="n">RandomLandmark</span><span class="p">)</span> <span class="k">if</span> <span class="n">q_learning</span> <span class="k">else</span> <span class="n">RectLandmark</span><span class="p">):</span>
                <span class="n">x_min</span> <span class="o">=</span> <span class="n">landmark</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">landmark</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">epsilon</span>
                <span class="n">x_max</span> <span class="o">=</span> <span class="n">landmark</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">landmark</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">epsilon</span>
                <span class="n">y_min</span> <span class="o">=</span> <span class="n">landmark</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">landmark</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">epsilon</span>
                <span class="n">y_max</span> <span class="o">=</span> <span class="n">landmark</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">landmark</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">epsilon</span>
                <span class="k">if</span> <span class="n">x_min</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">x_max</span> <span class="ow">and</span> <span class="n">y_min</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="n">y_max</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="raw_env.discrete">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.raw_env.discrete">[docs]</a>
    <span class="k">def</span> <span class="nf">discrete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_pos_x</span><span class="p">,</span> <span class="n">agent_pos_y</span><span class="p">,</span> <span class="n">goal_pos_x</span><span class="p">,</span> <span class="n">goal_pos_y</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Discretize free space into a 4â€‘connected grid and find nearest nodes.</span>

<span class="sd">        Builds a uniform grid, removes cells inside obstacles, connects</span>
<span class="sd">        4â€‘neighborhood, and returns the closest start and goal nodes.</span>

<span class="sd">        Args:</span>
<span class="sd">            agent_pos_x (float): Agent x.</span>
<span class="sd">            agent_pos_y (float): Agent y.</span>
<span class="sd">            goal_pos_x (float): Goal x.</span>
<span class="sd">            goal_pos_y (float): Goal y.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[Node | None, Node | None]: Start and end nodes on the free grid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cell_size</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">5e-2</span>
        <span class="n">num_steps_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mf">1.95</span> <span class="o">//</span> <span class="n">cell_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">num_steps_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mf">1.95</span> <span class="o">//</span> <span class="n">cell_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">grid</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># 2D node list for adding children nodes</span>
        <span class="n">node_grid</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps_y</span><span class="p">)]</span><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps_x</span><span class="p">)]</span>
        <span class="n">start_node</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">end_node</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">min_start_dist</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="n">min_end_dist</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        
        <span class="c1"># create nodes</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps_x</span><span class="p">):</span>
            <span class="n">x_coordinate</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.95</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">cell_size</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps_y</span><span class="p">):</span>
                <span class="n">y_coordinate</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.95</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">cell_size</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_obstacle</span><span class="p">(</span><span class="n">x_coordinate</span><span class="p">,</span> <span class="n">y_coordinate</span><span class="p">):</span>
                    <span class="n">new_node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">x_coordinate</span><span class="p">,</span> <span class="n">y_coordinate</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">node_grid</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_node</span>
                    <span class="n">grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_node</span><span class="p">)</span>
                    
                    <span class="n">dist_start</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">x_coordinate</span> <span class="o">-</span> <span class="n">agent_pos_x</span><span class="p">,</span> <span class="n">y_coordinate</span> <span class="o">-</span> <span class="n">agent_pos_y</span><span class="p">)</span>
                    <span class="n">dist_end</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">x_coordinate</span> <span class="o">-</span> <span class="n">goal_pos_x</span><span class="p">,</span> <span class="n">y_coordinate</span> <span class="o">-</span> <span class="n">goal_pos_y</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">dist_start</span> <span class="o">&lt;</span> <span class="n">min_start_dist</span><span class="p">:</span>
                        <span class="n">min_start_dist</span> <span class="o">=</span> <span class="n">dist_start</span>
                        <span class="n">start_node</span> <span class="o">=</span> <span class="n">new_node</span>

                    <span class="k">if</span> <span class="n">dist_end</span> <span class="o">&lt;</span> <span class="n">min_end_dist</span><span class="p">:</span>
                        <span class="n">min_end_dist</span> <span class="o">=</span> <span class="n">dist_end</span>
                        <span class="n">end_node</span> <span class="o">=</span> <span class="n">new_node</span>
            
        <span class="c1"># connect nodes</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps_x</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps_y</span><span class="p">):</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">node_grid</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># right</span>
                    <span class="k">if</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">num_steps_x</span> <span class="ow">and</span> <span class="n">node_grid</span><span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="p">]:</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">node_grid</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="p">])</span>
                    <span class="c1"># up</span>
                    <span class="k">if</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">num_steps_y</span> <span class="ow">and</span> <span class="n">node_grid</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">node_grid</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                    <span class="c1"># left</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">node_grid</span><span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="p">]:</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">node_grid</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="p">])</span>
                    <span class="c1"># down</span>
                    <span class="k">if</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">node_grid</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">node_grid</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">end_node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="p">(</span><span class="s2">&quot;Endknoten konnte nicht gefunden werden&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">start_node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="p">(</span><span class="s2">&quot;Startknoten konnte nicht gefunden werden&quot;</span><span class="p">)</span>
                            
        <span class="k">return</span> <span class="n">start_node</span><span class="p">,</span> <span class="n">end_node</span></div>

    

<div class="viewcode-block" id="raw_env.heuristic">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.raw_env.heuristic">[docs]</a>
    <span class="k">def</span> <span class="nf">heuristic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">end_node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return heuristic for A*.</span>

<span class="sd">        Currently returns zero to obtain Dijkstra behavior.</span>

<span class="sd">        Args:</span>
<span class="sd">            node (Node): Current node.</span>
<span class="sd">            end_node (Node): Goal node.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Heuristic estimate of remaining cost.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># euclidean distance</span>
        <span class="c1">#return ((node.x - end_node.x) ** 2 + (node.y - end_node.y) ** 2) ** 0.5</span>
        <span class="k">return</span> <span class="mi">0</span></div>



<div class="viewcode-block" id="raw_env.A_star">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.raw_env.A_star">[docs]</a>
    <span class="k">def</span> <span class="nf">A_star</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_node</span><span class="p">,</span> <span class="n">end_node</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute a shortest path on the discrete grid.</span>

<span class="sd">        Uses bestâ€‘first search with total cost g + h (A*) and reconstructs the path by</span>
<span class="sd">        following parent pointers.</span>

<span class="sd">        Args:</span>
<span class="sd">            start_node (Node): Start node.</span>
<span class="sd">            end_node (Node): Goal node.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[tuple[float, float]] | None: Path as a list of (x, y) positions</span>
<span class="sd">                in world coordinates. None if no path exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Open</span> <span class="o">=</span> <span class="p">[</span><span class="n">start_node</span><span class="p">]</span>
        <span class="n">Closed</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">start_node</span><span class="o">.</span><span class="n">cost_to_come</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">start_node</span><span class="o">.</span><span class="n">cost_to_go</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heuristic</span><span class="p">(</span><span class="n">start_node</span><span class="p">,</span> <span class="n">end_node</span><span class="p">)</span>
        <span class="n">start_node</span><span class="o">.</span><span class="n">total_cost</span> <span class="o">=</span> <span class="n">start_node</span><span class="o">.</span><span class="n">cost_to_come</span> <span class="o">+</span> <span class="n">start_node</span><span class="o">.</span><span class="n">cost_to_go</span>
        
        <span class="k">while</span> <span class="n">Open</span><span class="p">:</span>
            <span class="c1"># best first search method with total cost</span>
            <span class="n">current_node</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Open</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">node</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">total_cost</span><span class="p">)</span>
            <span class="n">Open</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">current_node</span><span class="p">)</span>
            <span class="n">Closed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_node</span><span class="p">)</span>
            
            <span class="c1"># check if end_node has been reached</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">current_node</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">current_node</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">end_node</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">end_node</span><span class="o">.</span><span class="n">y</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">while</span> <span class="n">current_node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">current_node</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">current_node</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
                    <span class="n">current_node</span> <span class="o">=</span> <span class="n">current_node</span><span class="o">.</span><span class="n">parent</span>
                <span class="k">return</span> <span class="n">path</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="c1"># check child nodes</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">current_node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">Closed</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># calculate new approx. cost</span>
                <span class="n">approx_cost_to_come</span> <span class="o">=</span> <span class="n">current_node</span><span class="o">.</span><span class="n">cost_to_come</span> <span class="o">+</span> <span class="n">child</span><span class="o">.</span><span class="n">cost</span>

                <span class="k">if</span> <span class="n">child</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Open</span><span class="p">:</span>
                    <span class="n">Open</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">approx_cost_to_come</span> <span class="o">&gt;=</span> <span class="n">child</span><span class="o">.</span><span class="n">cost_to_come</span><span class="p">:</span>
                    <span class="k">continue</span>  

                <span class="n">child</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">current_node</span>
                <span class="n">child</span><span class="o">.</span><span class="n">cost_to_come</span> <span class="o">=</span> <span class="n">approx_cost_to_come</span>
                <span class="n">child</span><span class="o">.</span><span class="n">cost_to_go</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heuristic</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">end_node</span><span class="p">)</span>
                <span class="n">child</span><span class="o">.</span><span class="n">total_cost</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">cost_to_come</span> <span class="o">+</span> <span class="n">child</span><span class="o">.</span><span class="n">cost_to_go</span>
                
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Open</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: No path found&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="raw_env.is_dyn_obstacle">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.raw_env.is_dyn_obstacle">[docs]</a>
    <span class="k">def</span> <span class="nf">is_dyn_obstacle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">current_agent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if a point is inside any other agent&#39;s disk.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (float): World x coordinate.</span>
<span class="sd">            y (float): World y coordinate.</span>
<span class="sd">            current_agent (Agent): Agent to exclude from the check.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the point intersects another agent.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
            <span class="c1"># agent should not detect himself as an obstacle</span>
            <span class="k">if</span> <span class="n">agent</span> <span class="o">==</span> <span class="n">current_agent</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">euclidian_dis</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">euclidian_dis</span> <span class="o">&lt;=</span> <span class="n">agent</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    
    
<div class="viewcode-block" id="raw_env.classify_region">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.raw_env.classify_region">[docs]</a>
    <span class="k">def</span> <span class="nf">classify_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid_region</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Classify a 3x4 region into free, passable, or impassable.</span>

<span class="sd">        Free if the number of obstacle cells is below a threshold.</span>
<span class="sd">        Passable if at least one row or column in the movement direction is fully free.</span>
<span class="sd">        Otherwise impassable.</span>

<span class="sd">        Args:</span>
<span class="sd">            grid_region (list[list[int]]): 3x4 binary subgrid.</span>
<span class="sd">            direction (str): One of &quot;top&quot;, &quot;bottom&quot;, &quot;left&quot;, &quot;right&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: 0 for free, 1 for passable, 2 for impassable.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If direction is not recognized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flat</span> <span class="o">=</span> <span class="p">[</span><span class="n">cell</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">grid_region</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span>
        <span class="n">obstacle_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">flat</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">obstacle_count</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>  <span class="c1"># free</span>

        <span class="k">if</span> <span class="n">direction</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">):</span>
            <span class="c1"># Check if there is **any passable column** (i.e., not all 1s)</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">grid_region</span><span class="p">))</span>  <span class="c1"># transpose</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">cell</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">):</span>
                <span class="k">return</span> <span class="mi">1</span>  <span class="c1"># passable</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">2</span>  <span class="c1"># impassable</span>

        <span class="k">elif</span> <span class="n">direction</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">):</span>
            <span class="c1"># Check if there is **any passable row** (i.e., not all 1s)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">cell</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">grid_region</span><span class="p">):</span>
                <span class="k">return</span> <span class="mi">1</span>  <span class="c1"># passable</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">2</span>  <span class="c1"># impassable</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown direction: </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    
    
<div class="viewcode-block" id="raw_env.q_learning_state_space">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.raw_env.q_learning_state_space">[docs]</a>
    <span class="k">def</span> <span class="nf">q_learning_state_space</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">a_star_new</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Encode the local observation for tabular Qâ€‘learning.</span>

<span class="sd">        Builds a binary occupancy grid around the agent, embeds the A* direction</span>
<span class="sd">        into the center cell, keeps the center 3Ã—3 at full resolution, and aggregates</span>
<span class="sd">        four 3Ã—4 directional regions into categorical labels.</span>

<span class="sd">        Args:</span>
<span class="sd">            agent (Agent): Agent to encode.</span>
<span class="sd">            a_star_new (list[tuple[float, float]]): Remaining A* path.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[int, ...]: Compact state tuple length 13.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">11</span>
        <span class="n">agent_grid</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">cell_size</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="n">agent_pos_x</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">agent_pos_y</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">start_pos_x</span> <span class="o">=</span> <span class="n">agent_pos_x</span> <span class="o">-</span> <span class="n">agent_grid</span><span class="o">*</span><span class="n">cell_size</span>
        <span class="n">start_pos_y</span> <span class="o">=</span> <span class="n">agent_pos_y</span> <span class="o">-</span> <span class="n">agent_grid</span><span class="o">*</span><span class="n">cell_size</span>

        <span class="c1"># raw grid with 0s and 1s</span>
        <span class="n">raw_grid</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">start_pos_x</span> <span class="o">+</span> <span class="n">c</span> <span class="o">*</span> <span class="n">cell_size</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">start_pos_y</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">cell_size</span>
                <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">agent_grid</span><span class="p">,</span> <span class="n">agent_grid</span><span class="p">):</span>
                    <span class="n">a_star_action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_star_direction</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">a_star_new</span><span class="p">)</span>
                    <span class="n">raw_grid</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_star_action</span>
                    <span class="n">agent</span><span class="o">.</span><span class="n">a_star_action</span> <span class="o">=</span> <span class="n">a_star_action</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_obstacle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">q_learning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">override_epsilon</span><span class="o">=</span><span class="mf">0.015</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dyn_obstacle</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">agent</span><span class="p">):</span>
                    <span class="n">raw_grid</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">state</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># --- Center 3x3 block: keep full resolution ---</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
                <span class="n">state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">raw_grid</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">])</span>
        
        <span class="c1"># --- Surrounding 3x4 blocks: aggregate to 1 if &gt;= 2 obstacles ---</span>
        <span class="c1"># Define regions:  top, left, right, bottom</span>
        <span class="n">surrounding_blocks</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;top&#39;</span><span class="p">:</span>    <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
            <span class="s1">&#39;left&#39;</span><span class="p">:</span>   <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
            <span class="s1">&#39;right&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
            <span class="s1">&#39;bottom&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
        <span class="p">}</span>


        <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">]:</span>
            <span class="n">r_start</span><span class="p">,</span> <span class="n">c_start</span><span class="p">,</span> <span class="n">r_end</span><span class="p">,</span> <span class="n">c_end</span> <span class="o">=</span> <span class="n">surrounding_blocks</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span>
            <span class="n">block</span> <span class="o">=</span> <span class="p">[</span><span class="n">raw_grid</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c_start</span><span class="p">:</span><span class="n">c_end</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r_start</span><span class="p">,</span> <span class="n">r_end</span><span class="p">)]</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classify_region</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
            <span class="n">state</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="raw_env.a_star_direction">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.raw_env.a_star_direction">[docs]</a>
    <span class="k">def</span> <span class="nf">a_star_direction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">a_star_new</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the dominant discrete direction toward the next target.</span>

<span class="sd">        Chooses either the goal or the nearest remaining A* waypoint and returns</span>
<span class="sd">        as a discrete action code.</span>

<span class="sd">        Args:</span>
<span class="sd">            agent (Agent): Agent instance.</span>
<span class="sd">            a_star_new (list[tuple[float, float]]): Remaining A* waypoints.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Discrete action code in {0 up, 1 down, 2 left, 3 right}.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">agent_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">a_star_new</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">goal_point</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">a_star_new</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">point</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="o">-</span> <span class="n">agent_pos</span><span class="p">))</span>
        
        <span class="n">dx</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">agent_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">agent_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Prioritize dominant direction</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dy</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">dx</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">dy</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="raw_env.last">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.raw_env.last">[docs]</a>
    <span class="k">def</span> <span class="nf">last</span><span class="p">(</span>
        
        <span class="bp">self</span><span class="p">,</span> <span class="n">observe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">ObsType</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return PettingZooâ€‘style observation tuple for the current agent.</span>

<span class="sd">        Also updates the agent&#39;s Qâ€‘state before returning.</span>

<span class="sd">        Args:</span>
<span class="sd">            observe (bool): If True, compute the observation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: (observation, reward, terminated, truncated, info, q_state)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_selection</span> <span class="c1"># current agent that is being stepped</span>
        <span class="k">assert</span> <span class="n">agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">observation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span> <span class="k">if</span> <span class="n">observe</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">agent_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_map</span><span class="p">[</span><span class="n">agent</span><span class="p">]]</span>
        
        <span class="n">agent_object</span><span class="o">.</span><span class="n">q_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_learning_state_space</span><span class="p">(</span><span class="n">agent_object</span><span class="p">,</span> <span class="n">agent_object</span><span class="o">.</span><span class="n">a_star_new</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">observation</span><span class="p">,</span>
            <span class="n">agent_object</span><span class="o">.</span><span class="n">reward</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">terminations</span><span class="p">[</span><span class="n">agent</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">truncations</span><span class="p">[</span><span class="n">agent</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">infos</span><span class="p">[</span><span class="n">agent</span><span class="p">],</span>
            <span class="n">agent_object</span><span class="o">.</span><span class="n">q_state</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="raw_env.reset">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.raw_env.reset">[docs]</a>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the environment and initialize perâ€‘agent A* paths and states.</span>

<span class="sd">        Randomizes start and goal positions subject to obstacle and separation constraints.</span>

<span class="sd">        Args:</span>
<span class="sd">            seed (int | None): seed.</span>
<span class="sd">            options (dict | None): Unused, kept for API compatibility.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[dict[str, tuple[int, ...]], dict[str, np.ndarray]]:</span>
<span class="sd">                Mapping from agent name to Qâ€‘state, and mapping to raw observation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">reset_world</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">np_random</span><span class="p">)</span>
        
        <span class="n">all_poses</span> <span class="o">=</span> <span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span> <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">entities</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixed_cam_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_poses</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">agents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">possible_agents</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rewards</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cumulative_rewards</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terminations</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">truncations</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">infos</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">agent_selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_selector</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_actions</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_agents</span>
        
        <span class="n">agent_states</span> <span class="o">=</span><span class="p">{}</span>
        <span class="n">agent_observations</span> <span class="o">=</span><span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">observation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
            <span class="n">start_node</span><span class="p">,</span> <span class="n">end_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discrete</span><span class="p">(</span><span class="n">observation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">observation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">observation</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">observation</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">agent_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_map</span><span class="p">[</span><span class="n">agent</span><span class="p">]]</span>
            <span class="n">a_star_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">A_star</span><span class="p">(</span><span class="n">start_node</span><span class="p">,</span> <span class="n">end_node</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">a_star_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Es konnte kein Pfad gefunden werden&quot;</span><span class="p">)</span>
            <span class="n">agent_object</span><span class="o">.</span><span class="n">a_star_new</span> <span class="o">=</span> <span class="n">a_star_path</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="c1"># remove first two elements</span>
            <span class="n">agent_object</span><span class="o">.</span><span class="n">a_star_old</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">agent_object</span><span class="o">.</span><span class="n">q_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_learning_state_space</span><span class="p">(</span><span class="n">agent_object</span><span class="p">,</span> <span class="n">agent_object</span><span class="o">.</span><span class="n">a_star_new</span><span class="p">)</span>
            <span class="n">agent_object</span><span class="o">.</span><span class="n">reward</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">agent_object</span><span class="o">.</span><span class="n">movable</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">agent_states</span><span class="p">[</span><span class="n">agent</span><span class="p">]</span> <span class="o">=</span> <span class="n">agent_object</span><span class="o">.</span><span class="n">q_state</span>
            <span class="n">agent_observations</span><span class="p">[</span><span class="n">agent</span><span class="p">]</span> <span class="o">=</span> <span class="n">observation</span>
            <span class="n">agent_object</span><span class="o">.</span><span class="n">controller_x</span> <span class="o">=</span> <span class="n">PID</span><span class="p">(</span><span class="n">setpoint</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">agent_object</span><span class="o">.</span><span class="n">controller_y</span> <span class="o">=</span> <span class="n">PID</span><span class="p">(</span><span class="n">setpoint</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">agent_object</span><span class="o">.</span><span class="n">terminated</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">agent_object</span><span class="o">.</span><span class="n">a_star_action</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">agent_object</span><span class="o">.</span><span class="n">start_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">agent_object</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">)</span>
            <span class="n">agent_object</span><span class="o">.</span><span class="n">trajectory</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">agent_object</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">)]</span> 
            
        <span class="k">return</span> <span class="n">agent_states</span><span class="p">,</span> <span class="n">agent_observations</span></div>

    
        
    <span class="k">def</span> <span class="nf">_skip_dead_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_selection</span>
        <span class="n">agent_obj</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">agent</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">agent_obj</span><span class="o">.</span><span class="n">movable</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="n">agent_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminations</span><span class="p">[</span><span class="n">agent</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">truncations</span><span class="p">[</span><span class="n">agent</span><span class="p">]</span> <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">agent_list</span><span class="p">):</span>
            <span class="k">return</span> 
        
        <span class="n">current_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_selection</span><span class="p">]</span>
        <span class="n">next_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_agents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_selector</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">next_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_execute_world_step</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cycles</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">truncations</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        
        
        
        
<div class="viewcode-block" id="raw_env.step">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.raw_env.step">[docs]</a>
    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Advance the environment by one agent action.</span>

<span class="sd">        Buffers the action, advances the world when the last agent has acted,</span>
<span class="sd">        updates rewards and terminations, and renders if enabled.</span>

<span class="sd">        Args:</span>
<span class="sd">            action (np.ndarray | int | None): Action for the selected agent. None if terminated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">terminations</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_selection</span><span class="p">]</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">truncations</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_selection</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_skip_dead_agent</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">cur_agent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_selection</span>
        <span class="n">current_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_selection</span><span class="p">]</span>
        <span class="n">next_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_agents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_selector</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_actions</span><span class="p">[</span><span class="n">current_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">action</span>

        <span class="k">if</span> <span class="n">next_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_execute_world_step</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cycles</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">truncations</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clear_rewards</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cumulative_rewards</span><span class="p">[</span><span class="n">cur_agent</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_accumulate_rewards</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_mode</span> <span class="o">==</span> <span class="s2">&quot;human&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span></div>


<div class="viewcode-block" id="raw_env.next_agent">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.raw_env.next_agent">[docs]</a>
    <span class="k">def</span> <span class="nf">next_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Advance the internal agent selector to the next agent.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">agent_selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent_selector</span><span class="o">.</span><span class="n">next</span><span class="p">()</span></div>

        
    
<div class="viewcode-block" id="raw_env.update_a_star_paths">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.raw_env.update_a_star_paths">[docs]</a>
    <span class="k">def</span> <span class="nf">update_a_star_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Advance and clean the remaining A* path for an agent.</span>

<span class="sd">        Removes already reached waypoints based on proximity. Clears the remaining path</span>
<span class="sd">        upon entering a goal neighborhood.</span>

<span class="sd">        Args:</span>
<span class="sd">            agent (Agent): Agent instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the path list or status changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">25e-3</span>
        <span class="n">goal_epsilon</span> <span class="o">=</span> <span class="mf">0.09</span>
        <span class="n">agent_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">)</span>
        <span class="n">goal_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">goal_point</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">agent_pos</span> <span class="o">-</span> <span class="n">goal_pos</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">goal_epsilon</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">a_star_new</span><span class="p">:</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">a_star_old</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">a_star_new</span><span class="p">)</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">a_star_new</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; reached goal proximity â€” cleared remaining path.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># Sort path points by distance (ascending) but prefer later ones in tie</span>
        <span class="n">sorted_path</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="nb">enumerate</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">a_star_new</span><span class="p">),</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">idx_point</span><span class="p">:</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">agent_pos</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idx_point</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="o">-</span><span class="n">idx_point</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">)</span>
        
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">path_x</span><span class="p">,</span> <span class="n">path_y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sorted_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">agent_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">path_x</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span> <span class="ow">and</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">agent_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">path_y</span><span class="p">,</span> <span class="n">abs_tol</span><span class="o">=</span><span class="n">epsilon</span><span class="p">):</span>
                <span class="c1"># Reached this A* point: remove all earlier ones too</span>
                <span class="n">reached_index</span> <span class="o">=</span> <span class="n">idx</span>
                <span class="n">reached_points</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">a_star_new</span><span class="p">[:</span><span class="n">reached_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">a_star_old</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">reached_points</span><span class="p">)</span>
                <span class="n">agent</span><span class="o">.</span><span class="n">a_star_new</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">a_star_new</span><span class="p">[</span><span class="n">reached_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; skipped to A* path point: </span><span class="si">{</span><span class="n">path_x</span><span class="p">,</span><span class="w"> </span><span class="n">path_y</span><span class="si">}</span><span class="s2"> â€” cleaned up </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">reached_points</span><span class="p">)</span><span class="si">}</span><span class="s2"> points&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>

    

    <span class="k">def</span> <span class="nf">_execute_world_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># update q-state and a* direction before stepping the agents</span>
        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">q_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_learning_state_space</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">agent</span><span class="o">.</span><span class="n">a_star_new</span><span class="p">)</span>
        <span class="c1"># set action for each agent</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">agent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">):</span>
            <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_actions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">scenario_action</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">movable</span><span class="p">:</span>
                <span class="n">mdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">dim_p</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">continuous_actions</span><span class="p">:</span>
                    <span class="n">scenario_action</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">mdim</span><span class="p">])</span>
                    <span class="n">action</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="n">mdim</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scenario_action</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span> <span class="o">%</span> <span class="n">mdim</span><span class="p">)</span>
                    <span class="n">action</span> <span class="o">//=</span> <span class="n">mdim</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent</span><span class="o">.</span><span class="n">silent</span><span class="p">:</span>
                <span class="n">scenario_action</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_action</span><span class="p">(</span><span class="n">scenario_action</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_spaces</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">))</span>
        <span class="n">global_reward</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_ratio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">global_reward</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">global_reward</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">))</span>
        

        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
            <span class="n">agent_reward</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">reward</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_a_star_paths</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_ratio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">reward</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">global_reward</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_ratio</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">agent_reward</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_ratio</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reward</span> <span class="o">=</span> <span class="n">agent_reward</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">rewards</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">reward</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">terminations</span><span class="p">[</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenario</span><span class="o">.</span><span class="n">is_termination</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">)</span>
            
<div class="viewcode-block" id="raw_env.get_next_point">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.raw_env.get_next_point">[docs]</a>
    <span class="k">def</span> <span class="nf">get_next_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent_x</span><span class="p">,</span> <span class="n">agent_y</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">agent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the next 1â€‘step grid target for a discrete action.</span>

<span class="sd">        Args:</span>
<span class="sd">            agent_x (float): Current x.</span>
<span class="sd">            agent_y (float): Current y.</span>
<span class="sd">            action (int): Discrete action in {0 up, 1 down, 2 left, 3 right}.</span>
<span class="sd">            agent (str): Agent name, unused but kept for symmetry.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[float, float]: Target point in world coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gridsize</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="n">goal_point</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#up</span>
            <span class="n">goal_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">agent_x</span>
            <span class="n">goal_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">agent_y</span><span class="o">+</span><span class="n">gridsize</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1">#down</span>
            <span class="n">goal_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">agent_x</span>
            <span class="n">goal_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">agent_y</span><span class="o">-</span><span class="n">gridsize</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1">#left</span>
            <span class="n">goal_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">agent_x</span><span class="o">-</span><span class="n">gridsize</span>
            <span class="n">goal_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">agent_y</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1">#right</span>
            <span class="n">goal_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">agent_x</span><span class="o">+</span><span class="n">gridsize</span>
            <span class="n">goal_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">agent_y</span>   
        
        <span class="k">return</span> <span class="n">goal_point</span></div>


<div class="viewcode-block" id="raw_env.get_cont_action">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.raw_env.get_cont_action">[docs]</a>
    <span class="k">def</span> <span class="nf">get_cont_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span> <span class="n">dimension</span><span class="p">,</span> <span class="n">discrete_action</span><span class="p">,</span> <span class="n">agent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert a discrete move into a continuous control vector.</span>

<span class="sd">        Sets PID setpoints one grid cell away, computes planar velocity commands,</span>
<span class="sd">        and maps them into the MPE action vector layout.</span>

<span class="sd">        Args:</span>
<span class="sd">            observation (np.ndarray): Current observation [x, y, goal_x, goal_y].</span>
<span class="sd">            dimension (int): World dimension, expected 2.</span>
<span class="sd">            discrete_action (int): Discrete action in {0,1,2,3}.</span>
<span class="sd">            agent (str): Agent name.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: Continuous action vector of length 2*dimension + 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">agent_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_map</span><span class="p">[</span><span class="n">agent</span><span class="p">]]</span>
        <span class="n">agent_object</span><span class="o">.</span><span class="n">action_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">discrete_action</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">agent_object</span><span class="o">.</span><span class="n">action_history</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">agent_object</span><span class="o">.</span><span class="n">action_history</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">next_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_next_point</span><span class="p">(</span><span class="n">observation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">observation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">discrete_action</span><span class="p">,</span> <span class="n">agent</span><span class="p">)</span>
        
        <span class="n">agent_object</span><span class="o">.</span><span class="n">controller_x</span><span class="o">.</span><span class="n">setpoint</span> <span class="o">=</span> <span class="n">next_point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">agent_object</span><span class="o">.</span><span class="n">controller_y</span><span class="o">.</span><span class="n">setpoint</span> <span class="o">=</span> <span class="n">next_point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">agent_object</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">agent_object</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_vel</span><span class="p">)</span>
        
        <span class="n">v_x</span> <span class="o">=</span> <span class="n">agent_object</span><span class="o">.</span><span class="n">controller_x</span><span class="p">(</span><span class="n">observation</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">v_y</span> <span class="o">=</span> <span class="n">agent_object</span><span class="o">.</span><span class="n">controller_y</span><span class="p">(</span><span class="n">observation</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">v_x</span> <span class="o">=</span> <span class="n">v_x</span> <span class="o">*</span> <span class="mf">1.25</span>
        <span class="n">v_y</span> <span class="o">=</span> <span class="n">v_y</span> <span class="o">*</span> <span class="mf">1.25</span>
        
        <span class="n">action</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dimension</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">action</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">v_x</span>
        <span class="n">action</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">v_y</span>
        <span class="k">return</span> <span class="n">action</span></div>
</div>



<span class="n">env</span> <span class="o">=</span> <span class="n">make_env</span><span class="p">(</span><span class="n">raw_env</span><span class="p">)</span>
<span class="n">parallel_env</span> <span class="o">=</span> <span class="n">parallel_wrapper_fn</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>


<div class="viewcode-block" id="Scenario">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.Scenario">[docs]</a>
<span class="k">class</span> <span class="nc">Scenario</span><span class="p">(</span><span class="n">BaseScenario</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Scenario with static shelf-like landmarks, random starts and goals, and rewards.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize default collision margins for runtime and planning.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_runtime</span> <span class="o">=</span> <span class="mf">5e-3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_planning</span> <span class="o">=</span> <span class="mf">9e-2</span>
    
<div class="viewcode-block" id="Scenario.make_world">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.Scenario.make_world">[docs]</a>
    <span class="k">def</span> <span class="nf">make_world</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_good</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_obstacles</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create world, agents, and rectangular landmarks.</span>

<span class="sd">        Args:</span>
<span class="sd">            num_good (int): Number of agents.</span>
<span class="sd">            num_obstacles (int): Number of rectangular obstacles.</span>

<span class="sd">        Returns:</span>
<span class="sd">            World: Configured world instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">world</span> <span class="o">=</span> <span class="n">World</span><span class="p">()</span>
        <span class="c1"># set any world properties first</span>
        <span class="n">world</span><span class="o">.</span><span class="n">dim_c</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">num_agents</span> <span class="o">=</span> <span class="n">num_good</span>
        <span class="n">num_landmarks</span> <span class="o">=</span> <span class="n">num_obstacles</span>
        <span class="c1"># add agents</span>
        <span class="n">world</span><span class="o">.</span><span class="n">agents</span> <span class="o">=</span> <span class="p">[</span><span class="n">Agent</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_agents</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">agent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">):</span>
            <span class="n">base_name</span> <span class="o">=</span>  <span class="s2">&quot;agent&quot;</span>
            <span class="n">base_index</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">base_index</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">collide</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">silent</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="mf">0.027</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">accel</span> <span class="o">=</span> <span class="mf">4.0</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">max_speed</span> <span class="o">=</span> <span class="mf">1.3</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">damping</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="c1"># add landmarks</span>
        <span class="n">world</span><span class="o">.</span><span class="n">landmarks</span> <span class="o">=</span> <span class="p">[</span><span class="n">RectLandmark</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_landmarks</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">landmark</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">landmarks</span><span class="p">):</span>
            <span class="n">landmark</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;landmark </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span>
            <span class="n">landmark</span><span class="o">.</span><span class="n">collide</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">landmark</span><span class="o">.</span><span class="n">movable</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">landmark</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">])</span>
            <span class="n">landmark</span><span class="o">.</span><span class="n">boundary</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">world</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">world</span></div>



<div class="viewcode-block" id="Scenario.reset_world">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.Scenario.reset_world">[docs]</a>
    <span class="k">def</span> <span class="nf">reset_world</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">,</span> <span class="n">np_random</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Randomize agent states and goal points.</span>

<span class="sd">        Ensures no overlap with obstacles, enforces interâ€‘agent spacing, and avoids</span>
<span class="sd">        goal conflicts.</span>

<span class="sd">        Args:</span>
<span class="sd">            world (World): World to modify.</span>
<span class="sd">            np_random (np.random.Generator): Random generator from PettingZoo.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>   <span class="c1"># green</span>
        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>   <span class="c1"># blue</span>
        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>   <span class="c1"># yellow</span>
        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>   <span class="c1"># orange</span>
        <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>   <span class="c1"># purple</span>
        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>   <span class="c1"># cyan</span>
        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>   <span class="c1"># magenta</span>
        <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>   <span class="c1"># olive</span>
        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>   <span class="c1"># teal</span>
        <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>   <span class="c1"># light blue</span>
        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span>   <span class="c1"># pinkish</span>
        <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>   <span class="c1"># light gray</span>
        <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span>   <span class="c1"># dark gray</span>
        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>   <span class="c1"># red</span>
        <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>   <span class="c1"># mauve</span>
        <span class="p">[</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span>   <span class="c1"># brown</span>
        <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span>   <span class="c1"># forest green</span>
        <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">],</span>   <span class="c1"># deep blue</span>
        <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>   <span class="c1"># lemon</span>
        <span class="p">[</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]</span>   <span class="c1"># violet</span>
        <span class="p">]</span>
        
        <span class="c1"># set states for landmarks</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">landmark</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">landmarks</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">landmark</span><span class="o">.</span><span class="n">boundary</span><span class="p">:</span>
                <span class="n">landmark</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">dim_p</span><span class="p">)</span>
                <span class="n">landmark</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">])</span>
        
        <span class="c1"># set initial states for rectangle landmarks</span>
        <span class="n">world</span><span class="o">.</span><span class="n">landmarks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">])</span>
        <span class="n">world</span><span class="o">.</span><span class="n">landmarks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
        <span class="n">world</span><span class="o">.</span><span class="n">landmarks</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">])</span>
        <span class="n">world</span><span class="o">.</span><span class="n">landmarks</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
        
        <span class="c1"># random properties for agents</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">agent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">):</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)])</span>
            <span class="p">)</span>
        
        <span class="k">for</span> <span class="n">agent</span> <span class="ow">in</span> <span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
            <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">dim_p</span><span class="p">)</span>
            
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">np_random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">world</span><span class="o">.</span><span class="n">dim_p</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_landmark</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="k">continue</span>
                
                <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span> <span class="o">=</span> <span class="n">pos</span>
                
                <span class="n">collision</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">other</span> <span class="ow">in</span> <span class="n">world</span><span class="o">.</span><span class="n">agents</span> 
                    <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">agent</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="p">)</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">collision</span><span class="p">:</span>
                    <span class="k">break</span>
                
                <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span> <span class="o">=</span> <span class="kc">None</span>
                
            <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">dim_c</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">np_random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mf">0.6</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">world</span><span class="o">.</span><span class="n">dim_p</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_landmark</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="k">continue</span>
                
                <span class="c1"># check minimum distance</span>
                <span class="n">start_pos</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="n">start_pos</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="p">:</span>
                    <span class="k">continue</span>
                
                <span class="n">goal_collision</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
                    <span class="nb">hasattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s1">&#39;goal_point&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">goal_point</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">goal_point</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">goal_point</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">0.15</span>
                    <span class="k">for</span> <span class="n">other</span> <span class="ow">in</span> <span class="n">world</span><span class="o">.</span><span class="n">agents</span> 
                    <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">agent</span>
                <span class="p">)</span>
            
                <span class="k">if</span> <span class="ow">not</span> <span class="n">goal_collision</span><span class="p">:</span>
                    <span class="n">agent</span><span class="o">.</span><span class="n">goal_point</span> <span class="o">=</span> <span class="n">pos</span>
                    <span class="k">break</span></div>

            

        
<div class="viewcode-block" id="Scenario.is_in_landmark">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.Scenario.is_in_landmark">[docs]</a>
    <span class="k">def</span> <span class="nf">is_in_landmark</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">,</span> <span class="n">pos_x</span><span class="p">,</span> <span class="n">pos_y</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if a point is inside any rectangle with planning margin.</span>

<span class="sd">        Args:</span>
<span class="sd">            world (World): World instance.</span>
<span class="sd">            pos_x (float): x coordinate.</span>
<span class="sd">            pos_y (float): y coordinate.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if inside any expanded rectangle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">landmark</span> <span class="ow">in</span> <span class="n">world</span><span class="o">.</span><span class="n">landmarks</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">landmark</span><span class="p">,</span> <span class="p">(</span><span class="n">RectLandmark</span><span class="p">,</span> <span class="n">RandomLandmark</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">landmark</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">x_min</span> <span class="o">=</span> <span class="n">landmark</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">landmark</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_planning</span>
                <span class="n">x_max</span> <span class="o">=</span> <span class="n">landmark</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">landmark</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_planning</span>
                <span class="n">y_min</span> <span class="o">=</span> <span class="n">landmark</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">landmark</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_planning</span>
                <span class="n">y_max</span> <span class="o">=</span> <span class="n">landmark</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">landmark</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_planning</span>
    
                <span class="k">if</span> <span class="n">x_min</span> <span class="o">&lt;=</span> <span class="n">pos_x</span> <span class="o">&lt;=</span> <span class="n">x_max</span> <span class="ow">and</span> <span class="n">y_min</span> <span class="o">&lt;=</span> <span class="n">pos_y</span> <span class="o">&lt;=</span> <span class="n">y_max</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

        
        
<div class="viewcode-block" id="Scenario.is_collision">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.Scenario.is_collision">[docs]</a>
    <span class="k">def</span> <span class="nf">is_collision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent1</span><span class="p">,</span> <span class="n">agent2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if two agents overlap with runtime margin.</span>

<span class="sd">        Args:</span>
<span class="sd">            agent1 (Agent): First agent.</span>
<span class="sd">            agent2 (Agent): Second agent.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if center distance is below sum of radii plus margin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">delta_pos</span> <span class="o">=</span> <span class="n">agent1</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span> <span class="o">-</span> <span class="n">agent2</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">delta_pos</span><span class="p">)))</span>
        <span class="n">dist_min</span> <span class="o">=</span> <span class="n">agent1</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">agent2</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_runtime</span>
        <span class="k">return</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">dist_min</span> <span class="k">else</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="Scenario.is_out_of_bounds">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.Scenario.is_out_of_bounds">[docs]</a>
    <span class="k">def</span> <span class="nf">is_out_of_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">margin</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if the agent is outside the square workspace.</span>

<span class="sd">        Args:</span>
<span class="sd">            agent (Agent): Agent instance.</span>
<span class="sd">            margin (float): Allowed slack beyond unit box.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if any coordinate exceeds the bound.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bound</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">margin</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">bound</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="Scenario.is_goal">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.Scenario.is_goal">[docs]</a>
    <span class="k">def</span> <span class="nf">is_goal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if the agent is within goal proximity.</span>

<span class="sd">        Args:</span>
<span class="sd">            agent (Agent): Agent instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if distance to goal is below size plus epsilon.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">epsilon_goal</span> <span class="o">=</span> <span class="mf">6e-3</span>
        <span class="n">delta_pos</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span> <span class="o">-</span> <span class="n">agent</span><span class="o">.</span><span class="n">goal_point</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">delta_pos</span><span class="p">)))</span>
        <span class="n">dist_min</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">epsilon_goal</span>
        <span class="k">return</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">dist_min</span> <span class="k">else</span> <span class="kc">False</span>  </div>

            
    
<div class="viewcode-block" id="Scenario.reward">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.Scenario.reward">[docs]</a>
    <span class="k">def</span> <span class="nf">reward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">world</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute shaped reward for a single agent.</span>

<span class="sd">        Penalizes collisions and out-of-bounds, adds small time penalty,</span>
<span class="sd">        and rewards A*-aligned actions.</span>

<span class="sd">        Args:</span>
<span class="sd">            agent (Agent): Agent instance.</span>
<span class="sd">            world (World): World instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Scalar reward for this agent and step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reward</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">landmark</span> <span class="ow">in</span> <span class="n">world</span><span class="o">.</span><span class="n">landmarks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">landmark</span><span class="o">.</span><span class="n">is_collision</span><span class="p">(</span><span class="n">agent</span><span class="p">):</span>
                <span class="n">reward</span> <span class="o">-=</span> <span class="mi">24</span>    <span class="c1"># collision</span>
                    
        <span class="k">for</span> <span class="n">other_agent</span> <span class="ow">in</span> <span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_collision</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">other_agent</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">other_agent</span> <span class="o">==</span> <span class="n">agent</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">reward</span> <span class="o">-=</span> <span class="mi">24</span>    <span class="c1"># collision</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_out_of_bounds</span><span class="p">(</span><span class="n">agent</span><span class="p">):</span>
            <span class="n">reward</span> <span class="o">-=</span> <span class="mi">24</span>            <span class="c1"># collision</span>
            
        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">a_star_action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">agent</span><span class="o">.</span><span class="n">action_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">agent</span><span class="o">.</span><span class="n">a_star_action</span><span class="p">:</span>
                <span class="n">reward</span> <span class="o">+=</span> <span class="mi">1</span>         <span class="c1"># choose a-star      </span>
    
        <span class="n">reward</span> <span class="o">-=</span> <span class="mf">1.2</span>          <span class="c1"># time penalty</span>

        <span class="n">agent</span><span class="o">.</span><span class="n">reward</span> <span class="o">=</span> <span class="n">reward</span>
        <span class="k">return</span> <span class="n">reward</span></div>


<div class="viewcode-block" id="Scenario.agents">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.Scenario.agents">[docs]</a>
    <span class="k">def</span> <span class="nf">agents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return list of agents.</span>

<span class="sd">        Args:</span>
<span class="sd">            world (World): World instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[Agent]: Agents in the world.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">world</span><span class="o">.</span><span class="n">agents</span></div>



<div class="viewcode-block" id="Scenario.observation">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.Scenario.observation">[docs]</a>
    <span class="k">def</span> <span class="nf">observation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">world</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return lowâ€‘level observation [x, y, goal_x, goal_y].</span>

<span class="sd">        Args:</span>
<span class="sd">            agent (Agent): Agent instance.</span>
<span class="sd">            world (World): World instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: Concatenated agent and goal positions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># world argument is kept because methods in the simple_env.py have it based on the original version of the observation method</span>
        <span class="n">agent_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">p_pos</span><span class="p">)</span>
        <span class="n">goal_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">agent</span><span class="o">.</span><span class="n">goal_point</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">agent_pos</span><span class="p">,</span> <span class="n">goal_pos</span><span class="p">))</span></div>


    
<div class="viewcode-block" id="Scenario.is_termination">
<a class="viewcode-back" href="../../api/mas_navigation.custom_environment.html#mas_navigation.custom_environment.Scenario.is_termination">[docs]</a>
    <span class="k">def</span> <span class="nf">is_termination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">world</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if the agent reached a terminal condition.</span>

<span class="sd">        Terminal events include collision, outâ€‘ofâ€‘bounds, or goal reached.</span>

<span class="sd">        Args:</span>
<span class="sd">            agent (Agent): Agent instance.</span>
<span class="sd">            world (World): World instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Termination flag.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">agent</span><span class="o">.</span><span class="n">terminated</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        
        <span class="n">termination</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">landmark</span> <span class="ow">in</span> <span class="n">world</span><span class="o">.</span><span class="n">landmarks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">landmark</span><span class="o">.</span><span class="n">is_collision</span><span class="p">(</span><span class="n">agent</span><span class="p">):</span>
                <span class="n">termination</span> <span class="o">=</span> <span class="kc">True</span>
                    
        <span class="k">for</span> <span class="n">other_agent</span> <span class="ow">in</span> <span class="n">world</span><span class="o">.</span><span class="n">agents</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_collision</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">other_agent</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">other_agent</span> <span class="o">==</span> <span class="n">agent</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">termination</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_out_of_bounds</span><span class="p">(</span><span class="n">agent</span><span class="p">):</span>
            <span class="n">termination</span> <span class="o">=</span> <span class="kc">True</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_goal</span><span class="p">(</span><span class="n">agent</span><span class="p">):</span>
            <span class="n">termination</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">return</span> <span class="n">termination</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Multi-Agent Path Planning and Navigation with A* and Q-Learning</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/mas_navigation.custom_environment.html">mas_navigation.custom_environment module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/mas_navigation.node_class.html">mas_navigation.node_class module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/mas_navigation.test.html">mas_navigation.test module</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Laura Hake.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>